# 状态管理

## 目录

[Redux](#jump1)

[React-redux](#jump2)

---	

<span id="jump1"></span>

## Redux

解决React数据管理（状态管理），用于中大型，数据比较庞大，组件之间数据交互多的情况下使用

### 几个概念

- Store:数据仓库，保存数据的地方。

- State:state是一个对象，数据仓库里的所有数据都放到一个state里。

- Action:一个动作，触发数据改变的方法。

- Dispatch:将动作触发成方法

- Reducer:是一个函数，通过获取动作，改变数据，生成一个新state。从而改变页面

### 使用步骤

安装

```shell
Cnpm install redux --save
```

导入必要组件

```javascript
import {createStore} from 'redux'
```

初始化数据

```javascript
// 创建仓库
const store = createStore(reducer)

// 初始化state
let state = {
  num: 0
}

// reducer有2个作用，1.初始化数据；2. 通过获取动作，改变数据
// action就是dispatch括号内传过来的参数
const reducer = function(state=state, action){
    switch(action.type){
        case "add":
            state.num++;
            break;
        case 'decrement':
            state.num--;
            break;
        default:
            break;
    }
	// 返回一个新的哈希值的state，值和原来相同
	// 如果是直接返回state，由于前后哈希值相同，react有可能认为是同一个数据而不更新渲染
    return {...state}
}
```

获取数据

```javascript
let state = store.getState()
```

修改数据（通过动作修改数据）

```javascript
// 通过仓库的方法dispatch进行修改数据
// 每次调用dispatch，都会调用reducer
// dispatch括号内的参数将作为reducer的action
store.dispatch({type:"add"})
```

修改视图（监听数据的变化，重新渲染内容）

```javascript
store.subscribe(()=>{
    ReactDOM.render(<Counter></Counter>,document.querySelector("#root"))
})
```

---

<span id="jump2"></span>

## React-redux

### 几个概念

- MapStatetoProps

mapStateToProps是一个函数

它的作用就是像它的名字那样，建立一个从（storte的）state对象到（UI 组件的）props对象的映射关系

作为函数，mapStateToProps执行后应该返回一个对象，里面的每一个键值对就是一个映射

mapStateToProps会订阅 Store，每当state更新的时候，就会自动执行，重新计算 UI 组件的参数，从而触发 UI 组件的重新渲染

- mapdispatchToProps

它可以是一个函数，也可以是一个对象

用来建立 UI 组件的参数到store.dispatch方法的映射。也就是说，它定义了哪些用户的操作应该当作 Action，传给 Store

- Connect方法

React-Redux 提供connect方法，用于从 UI 组件生成容器组件

```javascript
import { connect } from 'react-redux'

const VisibleTodoList = connect(
  mapStateToProps,
  mapDispatchToProps
)(TodoList)
```

上面代码中，connect方法接受两个参数：mapStateToProps和mapDispatchToProps。它们定义了 UI 组件的业务逻辑

前者负责输入逻辑，即将state映射到 UI 组件的参数（props），后者负责输出逻辑，即将用户对 UI 组件的操作映射成 Action

- Provider组件

connect方法生成容器组件以后，需要让容器组件拿到state对象，才能生成 UI 组件的参数

React-Redux 提供Provider组件，可以让容器组件拿到state

### 使用步骤

安装

```shell
cnpm install react-redux --save
```

导入必要组件

```javascript
import {createStore} from 'redux'
import {connect, Provider} from 'react-redux'
```

初始化数据

```javascript
const store = createStore(reducer)

let state = {
  num: 0
}

function reducer(state=state, action){
    switch(action.type){
        case "add":
            state.num++;
            break;
        default:
            break;
    }
    return {...state}
}
```

将store的state映射到到组件的props中

```javascript
function mapStateToProps(state) {
  return {
    value: state.num
  }
}
```

将修改数据的方法映射到组件的props中

```javascript
const addAction = {
  type: 'add'
}

function mapDispatchToProps(dispatch) {
  return {
    onAddClick: () => {dispatch(addAction)}
  }
}
```

使用connect将上述两个方法与目标组件进行关联

```javascript
const App = connect(
  mapStateToProps,
  mapDispatchToProps
)(TargetCom)
```

获取数据

```javascript
const value = this.props.value;
```

获取修改数据的方法

```javascript
const onAddClick = this.props.onAddClick;
```

包裹Provider

```javascript
render(
  <Provider store={store}>
    <TargetCom />
  </Provider>,
  document.getElementById('root')
)
```
